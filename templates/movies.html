{% extends "base.html" %}
{% block title %}Movies - Mini Control{% endblock %}
{% block page_title %}Movies{% endblock %}
{% block page_subtitle %}Manage local movies in /home/ludovic/movies with OMDb metadata and browser streaming{% endblock %}

{% block content %}
<style>
.movies-page {
    --m-surface: #16213e;
    --m-surface-soft: #1c2c4f;
    --m-border: rgba(78, 204, 163, 0.24);
    --m-accent: #4ecca3;
    --m-danger: #e94560;
    --m-blue: #2b7fcf;
    --m-text: #f8faff;
    --m-text-muted: #b7c2db;
    color: var(--m-text);
}

.movies-panel {
    background: linear-gradient(165deg, rgba(22, 33, 62, 0.92), rgba(15, 52, 96, 0.88));
    border: 1px solid var(--m-border);
    border-radius: 16px;
    box-shadow: 0 18px 34px rgba(8, 10, 20, 0.42);
    padding: 1rem;
}

.upload-panel {
    padding: 1.2rem;
    background:
        linear-gradient(125deg, rgba(26, 26, 46, 0.95) 0%, rgba(15, 52, 96, 0.9) 62%, rgba(78, 204, 163, 0.22) 100%),
        radial-gradient(circle at 12% 20%, rgba(78, 204, 163, 0.22), transparent 45%);
}

.upload-head {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.upload-head h2 {
    font-size: clamp(1.15rem, 2.1vw, 1.45rem);
    margin-bottom: 0.2rem;
}

.upload-head p {
    color: var(--m-text-muted);
    font-size: 0.9rem;
}

.movies-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.movies-btn {
    border: 1px solid transparent;
    border-radius: 10px;
    padding: 0.48rem 0.85rem;
    font-weight: 600;
    font-size: 0.82rem;
    color: #fff;
    cursor: pointer;
    transition: transform 0.16s ease, opacity 0.16s ease;
}

.movies-btn:hover {
    transform: translateY(-1px);
}

.movies-btn:disabled {
    opacity: 0.55;
    cursor: not-allowed;
    transform: none;
}

.movies-btn-primary {
    background: var(--m-accent);
    color: #0f1f31;
}

.movies-btn-muted {
    background: rgba(255, 255, 255, 0.14);
    border-color: rgba(255, 255, 255, 0.2);
}

.movies-btn-danger {
    background: var(--m-danger);
}

.movies-btn-blue {
    background: var(--m-blue);
}

.upload-dropzone {
    margin-top: 0.95rem;
    border: 2px dashed rgba(78, 204, 163, 0.5);
    background: rgba(8, 15, 32, 0.45);
    border-radius: 14px;
    padding: 1.2rem 0.9rem;
    text-align: center;
    transition: border-color 0.2s ease, background 0.2s ease;
}

.upload-dropzone.dragover {
    border-color: rgba(78, 204, 163, 0.95);
    background: rgba(15, 31, 52, 0.75);
}

.upload-dropzone strong {
    display: block;
    font-size: 0.98rem;
    margin-bottom: 0.22rem;
}

.upload-dropzone p {
    color: var(--m-text-muted);
    font-size: 0.84rem;
}

.upload-controls {
    margin-top: 0.75rem;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.6rem;
    flex-wrap: wrap;
}

.upload-input {
    display: none;
}

.upload-progress-wrap {
    margin-top: 0.75rem;
    display: none;
}

.upload-progress-wrap.active {
    display: block;
}

.upload-progress-track {
    height: 12px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.14);
    overflow: hidden;
}

.upload-progress-fill {
    height: 100%;
    width: 0;
    background: linear-gradient(90deg, #4ecca3, #24a680);
    transition: width 0.18s ease;
}

.upload-progress-text {
    margin-top: 0.4rem;
    color: var(--m-text-muted);
    font-size: 0.82rem;
}

.movies-alert {
    margin-top: 0.9rem;
    padding: 0.7rem 0.9rem;
    border-radius: 12px;
    border: 1px solid rgba(233, 69, 96, 0.38);
    background: rgba(233, 69, 96, 0.15);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.7rem;
    flex-wrap: wrap;
}

.movies-alert strong {
    display: block;
    margin-bottom: 0.15rem;
}

.movies-alert span {
    color: var(--m-text-muted);
    font-size: 0.86rem;
}

.movies-status {
    margin-top: 0.7rem;
    color: var(--m-text-muted);
    font-size: 0.86rem;
    min-height: 1.2rem;
}

.movies-status.error {
    color: #ffc1cc;
}

.movies-library {
    margin-top: 1rem;
}

.library-toolbar {
    display: grid;
    grid-template-columns: minmax(160px, 1fr) 150px auto auto auto;
    gap: 0.6rem;
    align-items: center;
}

.movies-input,
.movies-select {
    border: 1px solid rgba(183, 194, 219, 0.3);
    border-radius: 10px;
    background: rgba(14, 21, 45, 0.72);
    color: var(--m-text);
    padding: 0.58rem 0.72rem;
    font-size: 0.88rem;
}

.movies-input::placeholder {
    color: rgba(183, 194, 219, 0.72);
}

.movie-count {
    justify-self: end;
    color: var(--m-text-muted);
    font-size: 0.84rem;
}

.movies-grid {
    margin-top: 0.9rem;
    display: grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap: 0.85rem;
}

.movie-card {
    position: relative;
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 13px;
    overflow: hidden;
    padding: 0;
    cursor: pointer;
    background: linear-gradient(160deg, #1c2c4f, #11172a);
    aspect-ratio: 2 / 3;
    text-align: left;
    color: #fff;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.movie-card:hover {
    transform: scale(1.03);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.42);
}

.movie-card-image {
    position: absolute;
    inset: 0;
    background-position: center;
    background-size: cover;
    opacity: 0.95;
}

.movie-card-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(10, 11, 18, 0.05), rgba(9, 11, 22, 0.9) 72%);
    display: flex;
    align-items: flex-end;
    padding: 0.62rem;
}

.movie-card-title {
    font-size: 0.84rem;
    font-weight: 700;
    line-height: 1.3;
}

.movie-card-year {
    color: var(--m-text-muted);
    font-size: 0.74rem;
}

.movie-rating-badge {
    position: absolute;
    top: 0.5rem;
    right: 0.52rem;
    background: rgba(10, 15, 26, 0.86);
    border: 1px solid rgba(78, 204, 163, 0.8);
    color: var(--m-accent);
    border-radius: 999px;
    padding: 0.2rem 0.48rem;
    font-size: 0.74rem;
    font-weight: 700;
    opacity: 0;
    transform: translateY(-4px);
    transition: opacity 0.16s ease, transform 0.16s ease;
}

.movie-card:hover .movie-rating-badge {
    opacity: 1;
    transform: translateY(0);
}

.movies-empty {
    margin-top: 1rem;
    text-align: center;
    border: 1px dashed rgba(183, 194, 219, 0.35);
    border-radius: 13px;
    padding: 1.4rem 0.8rem;
    color: var(--m-text-muted);
    background: rgba(17, 23, 41, 0.64);
}

.movie-modal {
    position: fixed;
    inset: 0;
    background: rgba(4, 7, 14, 0.82);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    z-index: 999;
}

.movie-modal.open {
    display: flex;
}

.movie-modal-dialog {
    width: min(980px, 100%);
    max-height: calc(100vh - 2rem);
    overflow: auto;
    background: linear-gradient(170deg, rgba(22, 33, 62, 0.98), rgba(16, 24, 46, 0.98));
    border-radius: 16px;
    border: 1px solid rgba(78, 204, 163, 0.3);
    box-shadow: 0 22px 46px rgba(0, 0, 0, 0.55);
    position: relative;
}

.modal-close {
    position: absolute;
    top: 0.65rem;
    right: 0.65rem;
    z-index: 3;
}

.movie-modal-backdrop {
    height: 220px;
    background:
        linear-gradient(180deg, rgba(14, 18, 30, 0.25), rgba(14, 18, 30, 0.92)),
        radial-gradient(circle at 18% 20%, rgba(78, 204, 163, 0.32), transparent 48%),
        linear-gradient(130deg, #0f3460, #1a1a2e);
    background-size: cover;
    background-position: center;
}

.movie-modal-body {
    margin-top: -76px;
    position: relative;
    z-index: 2;
    padding: 0 1rem 1rem;
    display: grid;
    grid-template-columns: 210px minmax(0, 1fr);
    gap: 1rem;
}

.movie-modal-poster {
    width: 100%;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.26);
    background: linear-gradient(150deg, #1a1a2e, #0f3460);
    min-height: 290px;
    object-fit: cover;
}

.movie-modal-info h3 {
    font-size: clamp(1.18rem, 2.2vw, 1.7rem);
    margin-bottom: 0.35rem;
}

.movie-meta-row {
    display: flex;
    gap: 0.7rem;
    flex-wrap: wrap;
    color: var(--m-text-muted);
    font-size: 0.85rem;
    margin-bottom: 0.6rem;
}

.genre-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-bottom: 0.7rem;
}

.genre-pill {
    background: rgba(43, 127, 207, 0.2);
    border: 1px solid rgba(43, 127, 207, 0.55);
    border-radius: 999px;
    padding: 0.15rem 0.48rem;
    font-size: 0.75rem;
}

.movie-overview {
    color: #e7ecfb;
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 0.8rem;
    white-space: pre-wrap;
}

.movie-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 0.8rem;
}

.file-info {
    background: rgba(10, 15, 29, 0.52);
    border: 1px solid rgba(183, 194, 219, 0.2);
    border-radius: 12px;
    padding: 0.7rem;
    font-size: 0.82rem;
    color: var(--m-text-muted);
}

.file-info strong {
    color: #fff;
}

.omdb-modal-body {
    padding: 1rem;
}

.omdb-modal-body p {
    color: var(--m-text-muted);
    font-size: 0.87rem;
    margin-bottom: 0.7rem;
}

.omdb-form {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.56rem;
}

.omdb-hint {
    margin-top: 0.56rem;
    color: var(--m-text-muted);
    font-size: 0.78rem;
}

@media (max-width: 1350px) {
    .movies-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
    }
}

@media (max-width: 1080px) {
    .movies-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    .library-toolbar {
        grid-template-columns: minmax(140px, 1fr) 140px auto auto;
    }
    .movie-count {
        justify-self: start;
    }
}

@media (max-width: 760px) {
    .movie-modal-body {
        grid-template-columns: 1fr;
        margin-top: -44px;
    }
    .movie-modal-poster {
        max-width: 210px;
    }
    .omdb-form {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 640px) {
    .movies-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .library-toolbar {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="movies-page">
    <section class="movies-panel upload-panel">
        <div class="upload-head">
            <div>
                <h2>Upload Movies</h2>
                <p>Drag and drop video files to upload directly to <code>/home/ludovic/movies</code>.</p>
            </div>
            <div class="movies-actions">
                <button type="button" class="movies-btn movies-btn-muted" id="open-omdb-settings-btn">&#9881; OMDb Key</button>
                <button type="button" class="movies-btn movies-btn-primary" id="scan-library-btn">Scan Library</button>
            </div>
        </div>

        <div id="upload-dropzone" class="upload-dropzone">
            <strong>Drop video files here</strong>
            <p>Supported formats: mkv, mp4, avi, m4v, mov, wmv, flv, webm. Max size: 10GB per file.</p>
            <div class="upload-controls">
                <button type="button" class="movies-btn movies-btn-primary" id="select-files-btn">Choose Files</button>
                <input id="upload-file-input" class="upload-input" type="file" accept=".mkv,.mp4,.avi,.m4v,.mov,.wmv,.flv,.webm" multiple>
            </div>
        </div>

        <div id="upload-progress-wrap" class="upload-progress-wrap">
            <div class="upload-progress-track">
                <div id="upload-progress-fill" class="upload-progress-fill"></div>
            </div>
            <div id="upload-progress-text" class="upload-progress-text"></div>
        </div>

        <div id="upload-status" class="movies-status"></div>
    </section>

    <div id="omdb-key-banner" class="movies-alert" style="display:none;">
        <div>
            <strong>OMDb key missing</strong>
            <span>Add your OMDb API key to unlock posters, ratings, and metadata refresh for uploaded files.</span>
        </div>
        <button type="button" class="movies-btn movies-btn-primary" id="banner-open-settings-btn">Set OMDb Key</button>
    </div>

    <section class="movies-panel movies-library">
        <div class="library-toolbar">
            <input type="text" id="movie-filter-input" class="movies-input" placeholder="Filter local movies by title or filename">
            <select id="movie-sort-select" class="movies-select">
                <option value="date">Sort: Date Added</option>
                <option value="name">Sort: Name</option>
                <option value="rating">Sort: Rating</option>
            </select>
            <button type="button" class="movies-btn movies-btn-muted" id="refresh-movies-btn">Refresh Grid</button>
            <button type="button" class="movies-btn movies-btn-muted" id="refresh-metadata-btn">Refresh Missing Metadata</button>
            <div class="movie-count" id="movie-count">0 movies</div>
        </div>

        <div id="library-status" class="movies-status"></div>
        <div id="movies-grid" class="movies-grid"></div>
        <div id="movies-empty" class="movies-empty" style="display:none;">
            No movies yet. Drop files here or add files via Samba to <strong>/home/ludovic/movies</strong>, then click <strong>Scan Library</strong>.
        </div>
    </section>
</div>

<div id="movie-modal" class="movie-modal" role="dialog" aria-modal="true" aria-label="Movie details">
    <div class="movie-modal-dialog">
        <button type="button" class="movies-btn movies-btn-muted modal-close" id="movie-modal-close">&times;</button>
        <div id="movie-modal-backdrop" class="movie-modal-backdrop"></div>
        <div class="movie-modal-body">
            <img id="movie-modal-poster" class="movie-modal-poster" alt="Movie poster">
            <div class="movie-modal-info">
                <h3 id="movie-modal-title">Movie title</h3>
                <div class="movie-meta-row" id="movie-meta-row"></div>
                <div class="genre-pills" id="movie-genre-pills"></div>
                <p id="movie-overview" class="movie-overview"></p>
                <div class="movie-actions">
                    <button type="button" class="movies-btn movies-btn-primary" id="movie-play-btn">Play</button>
                    <button type="button" class="movies-btn movies-btn-blue" id="movie-open-file-btn">Open File</button>
                    <button type="button" class="movies-btn movies-btn-danger" id="movie-delete-btn">Delete</button>
                </div>
                <div class="file-info" id="movie-file-info"></div>
            </div>
        </div>
    </div>
</div>

<div id="omdb-modal" class="movie-modal" role="dialog" aria-modal="true" aria-label="OMDb settings">
    <div class="movie-modal-dialog" style="max-width:640px;">
        <button type="button" class="movies-btn movies-btn-muted modal-close" id="omdb-modal-close">&times;</button>
        <div class="omdb-modal-body">
            <h3>OMDb API Key</h3>
            <p>The key is saved to <code>~/.mini-control-omdb-key</code> on the server.</p>
            <form id="omdb-form" class="omdb-form">
                <input type="password" id="omdb-key-input" class="movies-input" placeholder="Paste OMDb API key">
                <button type="submit" class="movies-btn movies-btn-primary">Save Key</button>
            </form>
            <div class="movies-actions" style="margin-top:0.6rem;">
                <button type="button" class="movies-btn movies-btn-muted" id="omdb-clear-btn">Clear Key</button>
            </div>
            <div id="omdb-settings-status" class="movies-status"></div>
            <p class="omdb-hint">
                Get a free key at <a href="https://www.omdbapi.com/apikey.aspx" target="_blank" rel="noopener noreferrer">omdbapi.com/apikey.aspx</a>.
                Free tier limit: 1000 requests/day.
                Metadata cache: <code>/home/ludovic/movies/.metadata_cache.json</code>.
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var omdbKeySet = {{ omdb_key_set|tojson }};
var movies = [];
var selectedMovie = null;
var metadataHydrateRunning = false;

function apiJson(url, options) {
    return fetch(url, options || {}).then(function(response) {
        return response.json().catch(function() { return {}; }).then(function(payload) {
            if (!response.ok) {
                throw new Error(payload.error || payload.message || ('Request failed (' + response.status + ')'));
            }
            return payload;
        });
    });
}

function encodePath(path) {
    return String(path || '').split('/').map(function(part) {
        return encodeURIComponent(part);
    }).join('/');
}

function escapeHtml(value) {
    return String(value == null ? '' : value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function setStatus(elementId, message, isError) {
    var el = document.getElementById(elementId);
    if (!el) return;
    el.textContent = message || '';
    el.classList.toggle('error', !!isError);
}

function updateOmdbBanner() {
    var banner = document.getElementById('omdb-key-banner');
    banner.style.display = omdbKeySet ? 'none' : 'flex';
}

function sortAndFilterMovies() {
    var query = document.getElementById('movie-filter-input').value.trim().toLowerCase();
    var sort = document.getElementById('movie-sort-select').value;
    var list = movies.slice();

    if (query) {
        list = list.filter(function(movie) {
            return String(movie.display_title || '').toLowerCase().indexOf(query) !== -1
                || String(movie.filename || '').toLowerCase().indexOf(query) !== -1;
        });
    }

    if (sort === 'name') {
        list.sort(function(a, b) {
            return String(a.display_title || '').localeCompare(String(b.display_title || ''));
        });
    } else if (sort === 'rating') {
        list.sort(function(a, b) {
            return (Number(b.rating) || 0) - (Number(a.rating) || 0);
        });
    } else {
        list.sort(function(a, b) {
            return (Number(b.modified_ts) || 0) - (Number(a.modified_ts) || 0);
        });
    }

    return list;
}

function renderMovies() {
    var grid = document.getElementById('movies-grid');
    var empty = document.getElementById('movies-empty');
    var count = document.getElementById('movie-count');
    var list = sortAndFilterMovies();

    count.textContent = list.length + (list.length === 1 ? ' movie' : ' movies');
    grid.innerHTML = '';

    if (!list.length) {
        empty.style.display = 'block';
        return;
    }
    empty.style.display = 'none';

    list.forEach(function(movie) {
        var card = document.createElement('button');
        card.type = 'button';
        card.className = 'movie-card';

        var image = document.createElement('div');
        image.className = 'movie-card-image';
        if (movie.poster_url) {
            image.style.backgroundImage = 'url("' + movie.poster_url + '")';
        } else {
            image.style.backgroundImage = 'linear-gradient(140deg, #0f3460, #1a1a2e)';
        }

        var overlay = document.createElement('div');
        overlay.className = 'movie-card-overlay';

        var textWrap = document.createElement('div');
        var title = document.createElement('div');
        title.className = 'movie-card-title';
        title.textContent = movie.display_title || movie.filename || 'Unknown';
        var year = document.createElement('div');
        year.className = 'movie-card-year';
        year.textContent = movie.year ? String(movie.year) : 'Year unknown';
        textWrap.appendChild(title);
        textWrap.appendChild(year);
        overlay.appendChild(textWrap);

        var rating = document.createElement('div');
        rating.className = 'movie-rating-badge';
        rating.textContent = movie.rating ? ('\u2605 ' + Number(movie.rating).toFixed(1)) : 'No rating';

        card.appendChild(image);
        card.appendChild(overlay);
        card.appendChild(rating);
        card.addEventListener('click', function() {
            openMovieModal(movie);
        });
        grid.appendChild(card);
    });
}

function replaceMovie(updatedMovie) {
    if (!updatedMovie || !updatedMovie.filename) return;
    var idx = movies.findIndex(function(movie) {
        return movie.filename === updatedMovie.filename;
    });
    if (idx >= 0) {
        movies[idx] = updatedMovie;
    } else {
        movies.push(updatedMovie);
    }
}

function hydrateMissingMetadata() {
    if (!omdbKeySet || metadataHydrateRunning) return Promise.resolve();
    var queue = movies.filter(function(movie) { return !movie.has_metadata; });
    if (!queue.length) return Promise.resolve();

    metadataHydrateRunning = true;
    setStatus('library-status', 'Refreshing metadata for new files...');
    var index = 0;

    return new Promise(function(resolve) {
        function next() {
            if (index >= queue.length) {
                metadataHydrateRunning = false;
                renderMovies();
                setStatus('library-status', 'Metadata refresh completed.');
                resolve();
                return;
            }

            var item = queue[index++];
            apiJson('/movies/api/metadata/' + encodePath(item.filename), { cache: 'no-store' })
                .then(function(payload) {
                    if (payload.movie) {
                        replaceMovie(payload.movie);
                        renderMovies();
                    }
                })
                .catch(function() {})
                .finally(function() {
                    window.setTimeout(next, 180);
                });
        }
        next();
    });
}

function loadMovies(options) {
    options = options || {};
    if (!options.silent) {
        setStatus('library-status', 'Scanning /home/ludovic/movies...');
    }
    return apiJson('/movies/api/list?sort=' + encodeURIComponent(document.getElementById('movie-sort-select').value), { cache: 'no-store' })
        .then(function(payload) {
            movies = payload.movies || [];
            omdbKeySet = !!payload.omdb_key_set;
            updateOmdbBanner();
            renderMovies();
            if (!options.skipHydrate) {
                return hydrateMissingMetadata();
            }
            setStatus('library-status', 'Library refreshed.');
            return null;
        })
        .catch(function(err) {
            setStatus('library-status', err.message, true);
            throw err;
        });
}

function refreshMetadataForFile(filename) {
    if (!omdbKeySet) return Promise.resolve();
    return apiJson('/movies/api/metadata/' + encodePath(filename), { cache: 'no-store' })
        .then(function(payload) {
            if (payload.movie) {
                replaceMovie(payload.movie);
                renderMovies();
            }
        })
        .catch(function() {});
}

function openMovieModal(movie) {
    selectedMovie = movie;
    document.getElementById('movie-modal-title').textContent = movie.display_title || movie.filename;

    var backdrop = document.getElementById('movie-modal-backdrop');
    if (movie.poster_url) {
        backdrop.style.backgroundImage = 'linear-gradient(180deg, rgba(14, 18, 30, 0.25), rgba(14, 18, 30, 0.92)), url("' + movie.poster_url + '")';
    } else {
        backdrop.style.backgroundImage = 'linear-gradient(130deg, #0f3460, #1a1a2e)';
    }

    var poster = document.getElementById('movie-modal-poster');
    poster.src = movie.poster_url || '';
    poster.style.display = movie.poster_url ? 'block' : 'none';
    poster.alt = (movie.display_title || 'Movie') + ' poster';

    var meta = [];
    meta.push(movie.year ? String(movie.year) : 'Year unknown');
    if (movie.rating) meta.push('\u2605 ' + Number(movie.rating).toFixed(1));
    if (movie.runtime) meta.push(movie.runtime + ' min');
    if (movie.content_rating) meta.push(movie.content_rating);
    document.getElementById('movie-meta-row').textContent = meta.join(' \u2022 ');

    var genreWrap = document.getElementById('movie-genre-pills');
    genreWrap.innerHTML = '';
    (movie.genres || []).forEach(function(genre) {
        var pill = document.createElement('span');
        pill.className = 'genre-pill';
        pill.textContent = genre;
        genreWrap.appendChild(pill);
    });

    document.getElementById('movie-overview').textContent = movie.overview || 'No description available.';

    document.getElementById('movie-file-info').innerHTML =
        '<div><strong>Size:</strong> ' + escapeHtml(movie.file_size_human || 'Unknown') + '</div>' +
        '<div><strong>Format:</strong> ' + escapeHtml(movie.format || 'Unknown') + '</div>' +
        '<div><strong>Director:</strong> ' + escapeHtml(movie.director || 'Unknown') + '</div>' +
        '<div><strong>Cast:</strong> ' + escapeHtml((movie.actors || []).join(', ') || 'Unknown') + '</div>' +
        '<div><strong>Path:</strong> ' + escapeHtml(movie.file_path || ('/home/ludovic/movies/' + movie.filename)) + '</div>' +
        '<div><strong>Added:</strong> ' + escapeHtml(movie.modified_human || 'Unknown') + '</div>';

    document.getElementById('movie-modal').classList.add('open');
}

function closeMovieModal() {
    document.getElementById('movie-modal').classList.remove('open');
    selectedMovie = null;
}

function deleteSelectedMovie() {
    if (!selectedMovie) return;
    var label = selectedMovie.display_title || selectedMovie.filename;
    if (!confirm('Delete "' + label + '"? This cannot be undone.')) return;

    apiJson('/movies/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: selectedMovie.filename })
    })
    .then(function() {
        movies = movies.filter(function(movie) { return movie.filename !== selectedMovie.filename; });
        closeMovieModal();
        renderMovies();
        setStatus('library-status', 'Deleted ' + label);
    })
    .catch(function(err) {
        alert('Delete failed: ' + err.message);
    });
}

function playSelectedMovie() {
    if (!selectedMovie) return;
    window.open('/movies/stream/' + encodePath(selectedMovie.filename), '_blank');
}

function openSelectedMovieFile() {
    if (!selectedMovie) return;
    var filesPath = 'movies/' + selectedMovie.filename;
    window.open('/files/download/' + encodePath(filesPath), '_blank');
}

function openOmdbModal() {
    document.getElementById('omdb-key-input').value = '';
    setStatus('omdb-settings-status', '');
    document.getElementById('omdb-modal').classList.add('open');
}

function closeOmdbModal() {
    document.getElementById('omdb-modal').classList.remove('open');
}

function saveOmdbKey(keyValue) {
    apiJson('/movies/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ omdb_key: keyValue })
    })
    .then(function(payload) {
        omdbKeySet = !!payload.omdb_key_set;
        updateOmdbBanner();
        setStatus('omdb-settings-status', payload.message || 'Saved.');
        return loadMovies({ silent: true });
    })
    .catch(function(err) {
        setStatus('omdb-settings-status', err.message, true);
    });
}

function setUploadProgress(percent, text) {
    var wrap = document.getElementById('upload-progress-wrap');
    var fill = document.getElementById('upload-progress-fill');
    var label = document.getElementById('upload-progress-text');
    wrap.classList.add('active');
    fill.style.width = Math.max(0, Math.min(100, percent || 0)) + '%';
    label.textContent = text || '';
}

function resetUploadProgress() {
    document.getElementById('upload-progress-fill').style.width = '0%';
    document.getElementById('upload-progress-text').textContent = '';
    document.getElementById('upload-progress-wrap').classList.remove('active');
}

function uploadSingleFile(file, index, total) {
    return new Promise(function(resolve, reject) {
        var formData = new FormData();
        formData.append('file', file);

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/movies/upload');
        xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                var pct = (event.loaded / event.total) * 100;
                setUploadProgress(pct, 'Uploading ' + file.name + ' (' + (index + 1) + '/' + total + ') - ' + pct.toFixed(1) + '%');
            }
        };
        xhr.onreadystatechange = function() {
            if (xhr.readyState !== 4) return;
            var payload = {};
            try {
                payload = JSON.parse(xhr.responseText || '{}');
            } catch (e) {
                payload = {};
            }

            if (xhr.status >= 200 && xhr.status < 300) {
                resolve(payload);
            } else {
                reject(new Error(payload.error || ('Upload failed (' + xhr.status + ')')));
            }
        };
        xhr.onerror = function() {
            reject(new Error('Upload failed due to network error'));
        };
        xhr.send(formData);
    });
}

function uploadFiles(files) {
    if (!files || !files.length) return;

    var allowed = ['mkv', 'mp4', 'avi', 'm4v', 'mov', 'wmv', 'flv', 'webm'];
    var queue = Array.prototype.slice.call(files).filter(function(file) {
        var ext = file.name.split('.').pop().toLowerCase();
        return allowed.indexOf(ext) !== -1;
    });

    if (!queue.length) {
        setStatus('upload-status', 'No supported video files selected.', true);
        return;
    }

    setStatus('upload-status', 'Starting upload of ' + queue.length + ' file(s)...');
    var uploaded = 0;

    function next() {
        if (uploaded >= queue.length) {
            setStatus('upload-status', 'Upload complete. Scanning library...');
            resetUploadProgress();
            loadMovies({ silent: true }).finally(function() {
                setStatus('upload-status', 'Upload complete. Library refreshed.');
            });
            return;
        }

        var file = queue[uploaded];
        uploadSingleFile(file, uploaded, queue.length)
            .then(function(payload) {
                var relativeName = payload.filename || file.name;
                if (payload.movie) {
                    replaceMovie(payload.movie);
                    renderMovies();
                }
                return refreshMetadataForFile(relativeName).then(function() {
                    uploaded += 1;
                    next();
                });
            })
            .catch(function(err) {
                setStatus('upload-status', err.message, true);
                resetUploadProgress();
            });
    }

    next();
}

var dropzone = document.getElementById('upload-dropzone');
var uploadInput = document.getElementById('upload-file-input');
var selectBtn = document.getElementById('select-files-btn');

selectBtn.addEventListener('click', function() {
    uploadInput.click();
});

uploadInput.addEventListener('change', function() {
    uploadFiles(uploadInput.files);
    uploadInput.value = '';
});

['dragenter', 'dragover'].forEach(function(eventName) {
    dropzone.addEventListener(eventName, function(event) {
        event.preventDefault();
        event.stopPropagation();
        dropzone.classList.add('dragover');
    });
});

['dragleave', 'drop'].forEach(function(eventName) {
    dropzone.addEventListener(eventName, function(event) {
        event.preventDefault();
        event.stopPropagation();
        dropzone.classList.remove('dragover');
    });
});

dropzone.addEventListener('drop', function(event) {
    var files = event.dataTransfer ? event.dataTransfer.files : null;
    uploadFiles(files);
});

document.getElementById('scan-library-btn').addEventListener('click', function() {
    loadMovies({ skipHydrate: false });
});

document.getElementById('refresh-movies-btn').addEventListener('click', function() {
    loadMovies({ skipHydrate: true });
});

document.getElementById('refresh-metadata-btn').addEventListener('click', function() {
    hydrateMissingMetadata();
});

document.getElementById('movie-filter-input').addEventListener('input', renderMovies);
document.getElementById('movie-sort-select').addEventListener('change', renderMovies);

document.getElementById('movie-modal-close').addEventListener('click', closeMovieModal);
document.getElementById('movie-modal').addEventListener('click', function(event) {
    if (event.target === this) closeMovieModal();
});
document.getElementById('movie-play-btn').addEventListener('click', playSelectedMovie);
document.getElementById('movie-open-file-btn').addEventListener('click', openSelectedMovieFile);
document.getElementById('movie-delete-btn').addEventListener('click', deleteSelectedMovie);

document.getElementById('open-omdb-settings-btn').addEventListener('click', openOmdbModal);
document.getElementById('banner-open-settings-btn').addEventListener('click', openOmdbModal);
document.getElementById('omdb-modal-close').addEventListener('click', closeOmdbModal);
document.getElementById('omdb-modal').addEventListener('click', function(event) {
    if (event.target === this) closeOmdbModal();
});

document.getElementById('omdb-form').addEventListener('submit', function(event) {
    event.preventDefault();
    saveOmdbKey(document.getElementById('omdb-key-input').value.trim());
});

document.getElementById('omdb-clear-btn').addEventListener('click', function() {
    if (!confirm('Remove saved OMDb API key?')) return;
    saveOmdbKey('');
});

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeMovieModal();
        closeOmdbModal();
    }
});

updateOmdbBanner();
loadMovies({ skipHydrate: false });
</script>
{% endblock %}
