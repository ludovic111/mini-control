{% extends "base.html" %}
{% block title %}AI Assistant - Mini Control{% endblock %}
{% block page_title %}AI Assistant{% endblock %}
{% block page_subtitle %}Chat with Claude for diagnostics, edits, and command help{% endblock %}

{% block content %}
<div class="assistant-container">
    <!-- Top bar: model selector + settings -->
    <div class="assistant-toolbar">
        <div class="toolbar-left">
            <select id="model-select">
                <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                <option value="claude-sonnet-4-5-20241022">Claude Sonnet 4.5</option>
                <option value="claude-opus-4-20250514">Claude Opus 4</option>
                <option value="claude-opus-4-6-20250616">Claude Opus 4.6</option>
                <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5</option>
            </select>
            <button class="btn btn-sm btn-muted" onclick="clearChat()">Clear chat</button>
        </div>
        <div class="toolbar-right">
            <span class="key-status" id="key-status">
                {% if auth_method == 'oauth' %}
                <span class="status-dot status-active"></span> OAuth connected
                {% elif auth_method == 'apikey' %}
                <span class="status-dot status-active"></span> {{ masked_key }}
                {% else %}
                <span class="status-dot status-inactive"></span> Not connected
                {% endif %}
            </span>
            <button class="btn btn-sm btn-primary" onclick="toggleSettings()">Settings</button>
        </div>
    </div>

    <!-- Settings panel (hidden by default) -->
    <div id="settings-panel" class="settings-panel" style="display:none;">
        <div class="card">
            <div class="card-header">Authentication</div>
            <div class="card-body">
                <!-- OAuth section -->
                <div class="settings-section">
                    <h4 class="settings-section-title">Option 1: Anthropic OAuth (Recommended)</h4>
                    <p class="settings-hint">Sign in with your Anthropic account. No API key needed.</p>
                    <div class="settings-row">
                        {% if has_oauth %}
                        <span class="badge badge-success">OAuth Connected</span>
                        <button class="btn btn-sm btn-danger" onclick="disconnectOAuth()">Disconnect</button>
                        {% else %}
                        <a href="{{ url_for('oauth_start') }}" class="btn btn-success">Connect with Anthropic</a>
                        {% endif %}
                    </div>
                </div>

                <div class="settings-divider">
                    <span>OR</span>
                </div>

                <!-- API Key section -->
                <div class="settings-section">
                    <h4 class="settings-section-title">Option 2: API Key</h4>
                    <p class="settings-hint">Enter your Anthropic API key. Saved to <code>~/.mini-control-api-key</code> (permissions 600).</p>
                    <div class="settings-row">
                        <input type="password" id="api-key-input" placeholder="sk-ant-..." autocomplete="off">
                        <button class="btn btn-success" onclick="saveApiKey()">Save Key</button>
                    </div>
                    <p class="settings-hint" id="key-save-status"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat area -->
    <div class="chat-area" id="chat-area">
        <div class="chat-welcome" id="chat-welcome">
            <div class="welcome-icon">&#129302;</div>
            <h3>AI Assistant</h3>
            <p>Ask me anything about your Mac Mini server. I can help with system administration, troubleshooting, and configuration.</p>
            <p class="text-muted">I can see your system stats in real-time and help draft commands.</p>
            {% if not assistant_exec_enabled %}
            <p class="text-muted">Command execution from chat is disabled by server policy.</p>
            {% endif %}
            {% if not assistant_file_editor_enabled %}
            <p class="text-muted">Assistant file editor is disabled by server policy.</p>
            {% endif %}
        </div>
    </div>

    <!-- Input area -->
    <div class="chat-input-area">
        <form id="chat-form" class="chat-input-row">
            <textarea id="chat-input" placeholder="Ask Claude about your server..." rows="1" autocomplete="off"></textarea>
            <button type="submit" class="btn btn-success chat-send-btn" id="send-btn">Send</button>
        </form>
    </div>
</div>

<!-- File editor modal -->
<div id="editor-modal" class="modal" style="display:none;">
    <div class="modal-content modal-editor">
        <div class="modal-header">
            <h3 id="editor-title">Edit File</h3>
            <div class="editor-actions">
                <button class="btn btn-sm btn-success" onclick="saveFile()">Save</button>
                <button class="btn btn-sm btn-danger" onclick="closeEditor()">&times;</button>
            </div>
        </div>
        <div class="editor-body">
            <textarea id="editor-textarea" spellcheck="false"></textarea>
        </div>
        <div class="editor-footer">
            <span class="text-muted" id="editor-status"></span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var sending = false;
var currentEditPath = '';
var assistantExecEnabled = {{ assistant_exec_enabled|tojson }};
var assistantFileEditorEnabled = {{ assistant_file_editor_enabled|tojson }};

function toggleSettings() {
    var panel = document.getElementById('settings-panel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function saveApiKey() {
    var key = document.getElementById('api-key-input').value.trim();
    if (!key) { alert('Enter an API key'); return; }
    var status = document.getElementById('key-save-status');
    status.textContent = 'Saving...';
    fetch('/assistant/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ api_key: key })
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.error) {
            status.textContent = 'Error: ' + d.error;
            status.className = 'settings-hint text-danger';
        } else {
            status.textContent = 'Key saved successfully!';
            status.className = 'settings-hint text-success-msg';
            document.getElementById('api-key-input').value = '';
            document.getElementById('key-status').innerHTML =
                '<span class="status-dot status-active"></span> ' + escHtml(d.masked_key);
            setTimeout(function() { document.getElementById('settings-panel').style.display = 'none'; }, 1500);
        }
    })
    .catch(function() {
        status.textContent = 'Request failed';
        status.className = 'settings-hint text-danger';
    });
}

function disconnectOAuth() {
    if (!confirm('Disconnect OAuth? You will need to reconnect or use an API key.')) return;
    fetch('/assistant/oauth/disconnect', { method: 'POST' })
        .then(function() { location.reload(); });
}

function clearChat() {
    if (!confirm('Clear conversation history?')) return;
    fetch('/assistant/clear', { method: 'POST' })
        .then(function() {
            document.getElementById('chat-area').innerHTML =
                '<div class="chat-welcome" id="chat-welcome">' +
                '<div class="welcome-icon">&#129302;</div>' +
                '<h3>AI Assistant</h3>' +
                '<p>Ask me anything about your Mac Mini server.</p>' +
                '</div>';
        });
}

document.getElementById('chat-form').addEventListener('submit', function(e) {
    e.preventDefault();
    if (sending) return;
    var input = document.getElementById('chat-input');
    var msg = input.value.trim();
    if (!msg) return;

    // Hide welcome
    var welcome = document.getElementById('chat-welcome');
    if (welcome) welcome.style.display = 'none';

    // Add user message
    addMessage('user', msg);
    input.value = '';
    input.style.height = 'auto';
    sending = true;
    document.getElementById('send-btn').textContent = '...';

    // Add typing indicator
    var typingId = 'typing-' + Date.now();
    addTypingIndicator(typingId);

    var model = document.getElementById('model-select').value;
    fetch('/assistant/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg, model: model })
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        removeTypingIndicator(typingId);
        if (d.error) {
            addMessage('error', d.error);
        } else {
            addMessage('assistant', d.response);
        }
    })
    .catch(function() {
        removeTypingIndicator(typingId);
        addMessage('error', 'Request failed. Check your connection.');
    })
    .finally(function() {
        sending = false;
        document.getElementById('send-btn').textContent = 'Send';
    });
});

// Auto-resize textarea
document.getElementById('chat-input').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Enter to send, Shift+Enter for newline
document.getElementById('chat-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('chat-form').dispatchEvent(new Event('submit'));
    }
});

function addMessage(role, content) {
    var area = document.getElementById('chat-area');
    var wrapper = document.createElement('div');
    wrapper.className = 'chat-msg chat-msg-' + role;

    var bubble = document.createElement('div');
    bubble.className = 'chat-bubble chat-bubble-' + role;

    if (role === 'assistant') {
        bubble.innerHTML = renderMarkdown(content);
        attachRunButtons(bubble);
        attachEditButtons(bubble);
    } else if (role === 'error') {
        bubble.className = 'chat-bubble chat-bubble-error';
        bubble.textContent = content;
    } else {
        bubble.textContent = content;
    }

    wrapper.appendChild(bubble);
    area.appendChild(wrapper);
    area.scrollTop = area.scrollHeight;
}

function addTypingIndicator(id) {
    var area = document.getElementById('chat-area');
    var wrapper = document.createElement('div');
    wrapper.className = 'chat-msg chat-msg-assistant';
    wrapper.id = id;
    var bubble = document.createElement('div');
    bubble.className = 'chat-bubble chat-bubble-assistant typing-indicator';
    bubble.innerHTML = '<span></span><span></span><span></span>';
    wrapper.appendChild(bubble);
    area.appendChild(wrapper);
    area.scrollTop = area.scrollHeight;
}

function removeTypingIndicator(id) {
    var el = document.getElementById(id);
    if (el) el.remove();
}

function renderMarkdown(text) {
    // Split by code blocks first
    var parts = text.split(/(```[\s\S]*?```)/g);
    var html = '';
    for (var i = 0; i < parts.length; i++) {
        var part = parts[i];
        if (part.startsWith('```')) {
            // Code block
            var inner = part.slice(3, -3);
            var firstNewline = inner.indexOf('\n');
            var lang = '';
            var code = inner;
            if (firstNewline !== -1) {
                lang = inner.slice(0, firstNewline).trim();
                code = inner.slice(firstNewline + 1);
            }
            var isBash = (lang === 'bash' || lang === 'sh' || lang === 'shell');
            var isFilepath = lang.startsWith('filepath:');
            var filepath = isFilepath ? lang.slice(9) : '';

            html += '<div class="code-block-wrapper">';
            if (isBash && assistantExecEnabled) {
                html += '<button class="btn btn-sm btn-success code-run-btn" data-cmd="' + escAttr(code.trim()) + '">Run on server</button>';
            }
            if (isFilepath && filepath && assistantFileEditorEnabled) {
                html += '<button class="btn btn-sm btn-primary code-edit-btn" data-path="' + escAttr(filepath) + '">Open in editor</button>';
                html += '<span class="code-filepath">' + escHtml(filepath) + '</span>';
            }
            html += '<pre class="code-block"><code>' + escHtml(code) + '</code></pre>';
            html += '</div>';
        } else {
            // Regular text - basic markdown
            var rendered = escHtml(part);
            rendered = rendered.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            rendered = rendered.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
            rendered = rendered.replace(/\n/g, '<br>');
            html += rendered;
        }
    }
    return html;
}

function attachRunButtons(bubble) {
    var buttons = bubble.querySelectorAll('.code-run-btn');
    buttons.forEach(function(btn) {
        btn.addEventListener('click', function() {
            var cmd = this.getAttribute('data-cmd');
            var wrapper = this.closest('.code-block-wrapper');
            var existing = wrapper.querySelector('.cmd-output');
            if (existing) existing.remove();

            var outputDiv = document.createElement('div');
            outputDiv.className = 'cmd-output';
            outputDiv.textContent = 'Running...';
            wrapper.appendChild(outputDiv);

            fetch('/assistant/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: cmd })
            })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                outputDiv.textContent = d.output || d.error || '(no output)';
                if (d.returncode !== undefined && d.returncode !== 0) {
                    outputDiv.textContent += '\n[exit code: ' + d.returncode + ']';
                    outputDiv.className = 'cmd-output cmd-output-error';
                } else {
                    outputDiv.className = 'cmd-output cmd-output-ok';
                }
                document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
            })
            .catch(function() {
                outputDiv.textContent = 'Failed to execute command';
                outputDiv.className = 'cmd-output cmd-output-error';
            });
        });
    });
}

function attachEditButtons(bubble) {
    var buttons = bubble.querySelectorAll('.code-edit-btn');
    buttons.forEach(function(btn) {
        btn.addEventListener('click', function() {
            var path = this.getAttribute('data-path');
            openFileEditor(path);
        });
    });
}

// --- File Editor ---

function openFileEditor(filepath) {
    if (!assistantFileEditorEnabled) {
        alert('Assistant file editor is disabled by server policy.');
        return;
    }
    if (!filepath) {
        filepath = prompt('Enter the full file path to edit:');
        if (!filepath) return;
    }
    currentEditPath = filepath;
    document.getElementById('editor-title').textContent = 'Edit: ' + filepath;
    document.getElementById('editor-textarea').value = 'Loading...';
    document.getElementById('editor-status').textContent = '';
    document.getElementById('editor-modal').style.display = 'flex';

    fetch('/assistant/file/read', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: filepath })
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.error) {
            // File doesn't exist — open blank for new file
            if (d.error.indexOf('not found') !== -1) {
                document.getElementById('editor-textarea').value = '';
                document.getElementById('editor-status').textContent = 'New file — will be created on save';
            } else {
                document.getElementById('editor-textarea').value = '';
                document.getElementById('editor-status').textContent = 'Error: ' + d.error;
            }
        } else {
            document.getElementById('editor-textarea').value = d.content;
            document.getElementById('editor-status').textContent = 'Loaded ' + d.path;
        }
    })
    .catch(function() {
        document.getElementById('editor-textarea').value = '';
        document.getElementById('editor-status').textContent = 'Failed to load file';
    });
}

function saveFile() {
    if (!currentEditPath) return;
    var content = document.getElementById('editor-textarea').value;
    var status = document.getElementById('editor-status');
    status.textContent = 'Saving...';

    fetch('/assistant/file/write', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: currentEditPath, content: content })
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.error) {
            status.textContent = 'Error: ' + d.error;
        } else {
            status.textContent = 'Saved successfully to ' + d.path;
        }
    })
    .catch(function() {
        status.textContent = 'Save failed';
    });
}

function closeEditor() {
    document.getElementById('editor-modal').style.display = 'none';
    currentEditPath = '';
}

// Ctrl+S in editor to save
document.getElementById('editor-textarea').addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveFile();
    }
});

// Close editor on backdrop click
document.getElementById('editor-modal').addEventListener('click', function(e) {
    if (e.target === this) closeEditor();
});

function escHtml(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

function escAttr(s) {
    return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}
</script>
{% endblock %}
